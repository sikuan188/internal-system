# PCMS Staff Management System - Docker Compose with HTTPS Support
# åŸ¹æ­£ä¸­å­¸å“¡å·¥ç®¡ç†ç³»çµ± - æ”¯æ´ HTTPS çš„ Docker Compose é…ç½®
#
# æ­¤é…ç½®æ”¯æ´ HTTP å’Œ HTTPS é›™é‡è¨ªå•
# ä½¿ç”¨ç’°å¢ƒè®Šé‡æ§åˆ¶ SSL åŠŸèƒ½çš„å•Ÿç”¨/ç¦ç”¨
#
# ä½¿ç”¨æ–¹æ³•ï¼š
#   é–‹ç™¼ç’°å¢ƒ (HTTP): docker-compose -f docker-compose-https.yml up --build
#   ç”Ÿç”¢ç’°å¢ƒ (HTTPS): SSL_ENABLED=true docker-compose -f docker-compose-https.yml up --build
#   ä½¿ç”¨è‡ªç°½è­‰æ›¸: SSL_ENABLED=true SSL_DEV_MODE=true docker-compose -f docker-compose-https.yml up --build
#
version: '3.8'

services:
  # =================================================================
  # å¾Œç«¯æœå‹™ (Django REST Framework API)
  # =================================================================
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-development}
    container_name: pcms_staff_backend
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - ../backend:/app:cached
      - ../backend/db/sqlitedb:/app/db/sqlitedb:cached
      - backend_media:/app/media
      - backend_static:/app/staticfiles
      - ../backend/logs:/app/logs:cached
    ports:
      - "8000:8000"
    environment:
      - PYTHONPATH=/app
      - DJANGO_SETTINGS_MODULE=pcms_staff.settings
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - HTTPS_ENABLED=${SSL_ENABLED:-false}
      - SECURE_SSL_REDIRECT=${FORCE_HTTPS:-false}
    env_file:
      - ../backend/.env
    depends_on:
      - db_volume_holder
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/staff/', timeout=10)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # =================================================================
  # å‰ç«¯æœå‹™ (React.js æ‡‰ç”¨)
  # =================================================================
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile
      target: production
    container_name: pcms_staff_frontend
    volumes:
      - frontend_build:/usr/share/nginx/html:ro
    depends_on:
      - backend
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 5s
      retries: 3

  # =================================================================
  # Nginx åå‘ä»£ç†æœå‹™ (æ”¯æ´ HTTPS)
  # =================================================================
  nginx:
    image: nginx:stable-alpine
    container_name: pcms_staff_nginx_proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # æ ¹æ“š SSL æ¨¡å¼é¸æ“‡ä¸åŒçš„é…ç½®æ–‡ä»¶
      - ${NGINX_CONFIG:-./nginx/default.conf}:/etc/nginx/conf.d/default.conf:ro
      
      # SSL è­‰æ›¸ (æ ¹æ“šè­‰æ›¸é¡å‹æ›è¼‰ä¸åŒç›®éŒ„)
      - ${SSL_CERT_DIR:-./ssl/self-signed}:/etc/nginx/ssl:ro
      
      # å‰ç«¯éœæ…‹æ–‡ä»¶
      - frontend_build:/usr/share/nginx/html:ro
      
      # å¾Œç«¯éœæ…‹å’Œåª’é«”æ–‡ä»¶
      - backend_static:/usr/share/nginx/html/static:ro
      - backend_media:/usr/share/nginx/html/media:ro
      
      # Let's Encrypt webroot (ç”¨æ–¼è­‰æ›¸é©—è­‰)
      - certbot_webroot:/var/www/certbot:ro
      
      # Nginx æ—¥èªŒ
      - nginx_logs:/var/log/nginx
    environment:
      - SSL_ENABLED=${SSL_ENABLED:-false}
      - DOMAIN_NAME=${DOMAIN_NAME:-localhost}
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "${HEALTH_CHECK_URL:-http://localhost/}"]
      interval: 30s
      timeout: 5s
      retries: 3

  # =================================================================
  # æ•¸æ“šåº«å·æŒæœ‰è€…
  # =================================================================
  db_volume_holder:
    image: alpine:latest
    container_name: pcms_staff_db_volume_holder
    volumes:
      - sqlite_data:/data_volume
    command: >
      sh -c "
        echo 'ğŸ—„ï¸ Database volume holder started' &&
        mkdir -p /data_volume &&
        chmod 755 /data_volume &&
        echo 'âœ… Database directories ready' &&
        sleep infinity
      "
    restart: unless-stopped
    networks:
      - app-network

  # =================================================================
  # ç”¨æˆ¶åˆå§‹åŒ–æœå‹™
  # =================================================================
  init_users:
    build:
      context: ../backend
      dockerfile: Dockerfile
      target: ${BUILD_TARGET:-development}
    container_name: pcms_staff_init_users
    command: ./init_users.sh
    environment:
      - CREATE_TEST_DATA=${CREATE_TEST_DATA:-true}
      - PYTHONPATH=/app
      - DJANGO_SETTINGS_MODULE=pcms_staff.settings
    env_file:
      - ../backend/.env
    volumes:
      - ../backend:/app:cached
      - ../backend/db/sqlitedb:/app/db/sqlitedb:cached
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    restart: "no"

  # =================================================================
  # Certbot æœå‹™ (Let's Encrypt è­‰æ›¸è‡ªå‹•æ›´æ–°)
  # =================================================================
  certbot:
    image: certbot/certbot
    container_name: pcms_staff_certbot
    volumes:
      - ./ssl/letsencrypt:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
      - certbot_logs:/var/log/letsencrypt
    command: >
      sh -c "
        echo 'Certbot ready for certificate management' &&
        sleep infinity
      "
    profiles:
      - letsencrypt
    restart: unless-stopped
    networks:
      - app-network

# =================================================================
# Docker å·å®šç¾©
# =================================================================
volumes:
  sqlite_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/sqlite

  frontend_build:
    driver: local

  backend_static:
    driver: local

  backend_media:
    driver: local

  nginx_logs:
    driver: local

  # SSL è­‰æ›¸ç›¸é—œå·
  certbot_webroot:
    driver: local

  certbot_logs:
    driver: local

# =================================================================
# Docker ç¶²çµ¡å®šç¾©
# =================================================================
networks:
  app-network:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1